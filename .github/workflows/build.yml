name: Build macOS App with Icon

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  build-mac:
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller -r requirements.txt

      - name: Build with PyInstaller
        run: |
          # --icon: 指定图标文件
          # --noconfirm: 覆盖之前的文件
          # --windowed: 隐藏终端窗口
          pyinstaller --windowed --noconfirm --clean \
                      --name "ImageStitcher" \
                      --icon "app_icon.icns" \
                      --collect-all PyQt6 \
                      --collect-all pillow_heif \
                      main.py

      - name: Fix macOS DPI and Bundle Metadata
        run: |
          # 这一步通过修改 Info.plist 强制启用高 DPI (Retina) 支持
          PLIST="dist/ImageStitcher.app/Contents/Info.plist"
          if [ -f "$PLIST" ]; then
            defaults write "$(pwd)/$PLIST" NSHighResolutionCapable -bool YES
          fi

      - name: Zip App Bundle
        run: |
          cd dist
          zip -r ImageStitcher-macOS.zip ImageStitcher.app

      - name: Create Release and Upload Asset
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: dist/ImageStitcher-macOS.zip
          token: ${{ secrets.GITHUB_TOKEN }}
